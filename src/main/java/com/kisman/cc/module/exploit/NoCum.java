package com.kisman.cc.module.exploit;

import com.kisman.cc.Kisman;
import com.kisman.cc.event.events.PacketEvent;
import com.kisman.cc.module.*;
import com.kisman.cc.settings.Setting;
import i.gishreloaded.gishcode.utils.visual.ChatUtils;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.network.play.server.SPacketBlockChange;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.ChunkPos;
import net.minecraft.util.math.Vec3d;
import net.minecraft.util.text.TextFormatting;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;
import net.minecraftforge.fml.common.network.FMLNetworkEvent;
import org.lwjgl.opengl.Display;

import java.text.DecimalFormat;
import java.util.ArrayList;

public class NoCum extends Module {
    private Setting noCum = new Setting("No Cum", this, false);
    private Setting ignore = new Setting("Ignore", this, true);
    private Setting latency = new Setting("Latency", this, false);
    private Setting ignoreLoaded = new Setting("Ignore Loaded", this, true);
    private Setting loadChunks = new Setting("Load Chunks", this, false);
    private Setting notify = new Setting("Notify", this, false);

    private Setting noCumAround = new Setting("No Cum Around", this, false);

    private Setting noCumHighway = new Setting("No Cum Highway", this, false);

    private Setting noCumMTracker = new Setting("No Cum M Tracker", this, false);

    private Setting noCumScanner = new Setting("No Cum Scanner", this, false);

    private Setting noCumSpiral = new Setting("No Cum Spiral", this, false);
    private final Setting noCumSpiralMode = new Setting("No Cum Spiral Mode", this, NoCumSpiralModes.ZERO_ZERO);

    private Setting noCumTracker = new Setting("No Cum Tracker", this, false);

    //other vars
    private boolean isNoCumToggled;
    private boolean isNoCumSpiralToggled;

    //NoCum vars
    private ArrayList<ChunkPos> loadedChunks = new ArrayList<>();
    private final int MAX_DL_PTT = 15;
    private long startTime;
    public int x, y, z;

    //NoCum Spiral vars
    public int spiralX, spiralZ, sx, sz, center_x, center_z, steps, centreX, centreY, max, skip, step;
    private boolean isSkipping = false;

    //instance
    public static NoCum instance;

    public NoCum() {
        super("NoCum", Category.EXPLOIT);

        instance = this;

        setmgr.rSetting(new Setting("cam1", this, "No Cum"));
        setmgr.rSetting(noCum);
        setmgr.rSetting(latency);
        setmgr.rSetting(ignoreLoaded);
        setmgr.rSetting(loadChunks);
        setmgr.rSetting(notify);

        setmgr.rSetting(new Setting("c3am1", this, "No Cum Around"));
        setmgr.rSetting(noCumAround);

        setmgr.rSetting(new Setting("cam41", this, "No Cum Highway"));
        setmgr.rSetting(noCumHighway);

        setmgr.rSetting(new Setting("c6am1", this, "No Cum M Tracker"));
        setmgr.rSetting(noCumMTracker);

        setmgr.rSetting(new Setting("cgam1", this, "No Cum Scanner"));
        setmgr.rSetting(noCumScanner);

        setmgr.rSetting(new Setting("camn1", this, "No Cum Spiral"));
        setmgr.rSetting(noCumSpiral);

        setmgr.rSetting(new Setting("cahm1", this, "No Cum Tracker"));
        setmgr.rSetting(noCumTracker);
    }

    public void onEnable() {
        Kisman.EVENT_BUS.subscribe(receive);
        if (mc.world == null) return;
        final BlockPos pos = new BlockPos(x, y, z);
        this.startTime = System.currentTimeMillis();
        mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, pos, EnumFacing.UP));
    }

    public void onDisable() {
        Kisman.EVENT_BUS.unsubscribe(receive);
        startTime = -1;
        unloadChunks();
    }

    public void update() {

    }

    @SubscribeEvent
    public void onConnect(FMLNetworkEvent.ClientConnectedToServerEvent event) {
        unloadChunks();
    }

    @EventHandler
    private final Listener<PacketEvent.Receive> receive = new Listener<>(event -> {
        if(isNoCumToggled) {
            if(event.getPacket() instanceof SPacketBlockChange) {
                SPacketBlockChange packet = (SPacketBlockChange) event.getPacket();
                ChunkPos chunkPos = new ChunkPos(packet.getBlockPosition());
                if (this.ignore.getValBoolean()) {
                    if (!this.loadedChunks.contains(chunkPos) && mc.world.isBlockLoaded(packet.getBlockPosition(), false)) return;
                    if (this.notify.getValBoolean() && !Display.isActive()) ChatUtils.message("DL found something.");
                }
                final DecimalFormat df = new DecimalFormat("#.#");
                final Vec3d pos1 = new Vec3d(mc.player.getPosition().getX(), packet.getBlockPosition().getY(), mc.player.getPosition().getZ());
                ChatUtils.message("&7[&aM&7] &r" + TextFormatting.RED + "[DL]: " + TextFormatting.RESET + packet.getBlockPosition() + " -> " + packet.getBlockState().getBlock().getLocalizedName() + " (" + df.format(pos1.distanceTo(new Vec3d(packet.getBlockPosition()))) + ") " + ((mc.player.dimension == -1) ? "Nether" : ""));
                if (latency.getValBoolean() && startTime != -1L) {
                    ChatUtils.message("Latency = " + (System.currentTimeMillis() - this.startTime) + " ms");
                    startTime = -1L;
                }
                if (loadChunks.getValBoolean() && loadChunks.isVisible() && !this.loadedChunks.contains(chunkPos)) {
                    mc.world.doPreChunk(chunkPos.x, chunkPos.z, true);
                    this.loadedChunks.add(chunkPos);
                }
            }
        }
    });

    private void unloadChunks() {
        if (mc.world != null) for (ChunkPos chunkPos : loadedChunks) mc.world.doPreChunk(chunkPos.x, chunkPos.z, false);
        loadedChunks.clear();
    }

    public void set(String var, int value) {
        switch(var) {
            case "x":
                x = value;
                break;
            case "z":
                z = value;
            case "centreX":
            case "centrex":
                centreX = value;
                break;
            case "centreY":
            case "centrey":
                centreY = value;
                break;
            case "max":
                max = value;
                break;
            case "step":
                step = value;
                break;
            case "skip":
                skip = value;
                break;
        }
    }

    public enum NoCumSpiralModes {ZERO_ZERO, YOU, CUSTOM}
}
