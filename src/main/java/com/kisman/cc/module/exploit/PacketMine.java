package com.kisman.cc.module.exploit;

import com.kisman.cc.Kisman;
import com.kisman.cc.module.Category;
import com.kisman.cc.module.Module;
import com.kisman.cc.settings.Setting;
import com.kisman.cc.util.RenderUtil;
import i.gishreloaded.gishcode.utils.TimerUtils;
import i.gishreloaded.gishcode.utils.visual.ChatUtils;
import net.minecraft.block.Block;
import net.minecraft.init.Blocks;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.EnumHand;
import net.minecraft.util.math.RayTraceResult;
import net.minecraft.util.math.Vec3d;
import net.minecraftforge.client.event.RenderWorldLastEvent;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;

import static i.gishreloaded.gishcode.utils.BlockUtils.getBlock;

public class PacketMine extends Module {
    Block broken;

    long startMs = 0L;

    TimerUtils timer;

    private int render;

    public PacketMine() {
        super("PacketMine", "PacketMine", Category.EXPLOIT);

        Kisman.instance.settingsManager.rSetting(new Setting("voidsetting", this, "void", "setting"));

        this.timer = new TimerUtils();
    }

    public void onEnable() {
        render = 0;
    }

    public void onDisable() {
        render = 0;
    }

    public void update() {
        if(mc.player == null && mc.world == null) return;

        if (mc.gameSettings.keyBindAttack.isKeyDown()) {
            if(mc.objectMouseOver.entityHit != null) {
                return;
            }

            if (mc.world.getBlockState(mc.objectMouseOver.getBlockPos()).getBlockHardness(mc.world, mc.objectMouseOver.getBlockPos()) == -1) {
                return;
            }

            if (getBlock(mc.objectMouseOver.getBlockPos()) != Blocks.AIR && getBlock(mc.objectMouseOver.getBlockPos()) != null) {
                if (broken == null || broken == Blocks.AIR || Math.abs(startMs - System.currentTimeMillis()) > 15000) { // через скока милисекунд после удара он будет ломать блок
                    broken = getBlock(mc.objectMouseOver.getBlockPos());
                    startMs = System.currentTimeMillis();
                }

                render = 1;

                render = 2;

                mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, mc.objectMouseOver.getBlockPos(), mc.objectMouseOver.sideHit));
                mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, mc.objectMouseOver.getBlockPos(), mc.objectMouseOver.sideHit));
                mc.player.swingArm(EnumHand.MAIN_HAND);

                render = 0;
            }
            try {
                System.out.println("55555");
            } catch (Exception e) {
                ChatUtils.error("Block " + mc.objectMouseOver.getBlockPos().getX() + mc.objectMouseOver.getBlockPos().getY() + mc.objectMouseOver.getBlockPos().getZ() + " is not BLOCK!");

            }


        }
    }

    @SubscribeEvent
    public void onRenderWorld(RenderWorldLastEvent event) {
        try {
            if(render != 0) {
                if(render == 1) {
                    RenderUtil.drawBlockESP(mc.objectMouseOver.getBlockPos(), 1, 0, 0);
                } else if(render == 2) {
                    RenderUtil.drawBlockESP(mc.objectMouseOver.getBlockPos(), 0, 1, 0);
                }
            }
        } catch (Exception e) {}
    }
}
