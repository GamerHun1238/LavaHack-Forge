package com.kisman.cc.features.module.exploit;

import com.kisman.cc.Kisman;
import com.kisman.cc.event.events.EventPlayerDamageBlock;
import com.kisman.cc.features.module.Category;
import com.kisman.cc.features.module.Module;
import com.kisman.cc.util.entity.player.InventoryUtil;
import me.zero.alpine.listener.Listener;
import net.minecraft.inventory.ClickType;
import net.minecraft.item.ItemStack;
import net.minecraft.network.play.client.CPacketClickWindow;

public class HandMineRewrite extends Module {

    public HandMineRewrite(){
        super("HandMine", Category.EXPLOIT);
    }

    private int slot = -1;

    @Override
    public void onEnable() {
        super.onEnable();
        if(mc.player == null || mc.world == null){
            toggle();
            return;
        }
        slot = -1;
        Kisman.EVENT_BUS.subscribe(preListener);
        Kisman.EVENT_BUS.subscribe(postListener);
    }

    @Override
    public void onDisable() {
        super.onDisable();
        Kisman.EVENT_BUS.unsubscribe(preListener);
        Kisman.EVENT_BUS.unsubscribe(postListener);
    }

    private final Listener<EventPlayerDamageBlock.Pre> preListener = new Listener<>(event -> {
        slot = InventoryUtil.findBestToolSlot(event.getPos());
        if(slot == -1)
            return;
        slot += 36;
        short id = mc.player.openContainer.getNextTransactionID(mc.player.inventory);
        ItemStack itemStack = mc.player.openContainer.slotClick(slot, mc.player.inventory.currentItem, ClickType.SWAP, mc.player);
        mc.player.connection.sendPacket(new CPacketClickWindow(mc.player.inventoryContainer.windowId, slot, mc.player.inventory.currentItem, ClickType.SWAP, itemStack, id));
    });

    private final Listener<EventPlayerDamageBlock.Post> postListener = new Listener<>(event -> {
        if(slot == -1)
            return;
        short id = mc.player.openContainer.getNextTransactionID(mc.player.inventory);
        ItemStack itemStack = mc.player.openContainer.slotClick(slot, mc.player.inventory.currentItem, ClickType.SWAP, mc.player);
        mc.player.connection.sendPacket(new CPacketClickWindow(mc.player.inventoryContainer.windowId, slot, mc.player.inventory.currentItem, ClickType.SWAP, itemStack, id));
    });
}
